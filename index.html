<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram –ë–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥ (–ë–í–§–ë)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="container mx-auto px-4 py-8">

    <!-- Header -->
    <header class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
            <i class="fas fa-robot text-blue-500 mr-3"></i>
            Telegram –ë–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥
        </h1>
        <p class="text-gray-600 text-lg max-w-3xl mx-auto">
            –ü–æ–ª—É—á–∞–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ü–µ–Ω–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏ –∏—Ç–æ–≥–∞—Ö —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ä—ã–Ω–æ–∫) —á–µ—Ä–µ–∑ Telegram.
        </p>
    </header>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Left Column: Security Information -->
        <div class="bg-white rounded-2xl card-shadow p-6">
            <div class="flex items-start justify-between gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-line text-green-500 mr-2"></i>
                        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ
                    </h2>
                    <div class="mt-2 text-sm text-gray-500">
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: <span id="lastUpdated" class="font-medium text-gray-700">‚Äî</span>
                    </div>
                </div>

                <div class="flex flex-col items-end gap-2">
                    <span class="bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full">
                        –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </span>
                    <button id="refreshDataBtn" class="inline-flex items-center gap-2 text-sm px-3 py-2 rounded-xl border border-blue-200 text-blue-700 hover:bg-blue-50 transition">
                        <i class="fas fa-rotate"></i>
                        –û–±–Ω–æ–≤–∏—Ç—å —Å –ë–í–§–ë
                    </button>
                </div>
            </div>

            <!-- Source Info -->
            <div class="mb-6 p-4 bg-blue-50 rounded-xl">
                <div class="flex items-center mb-2">
                    <i class="fas fa-link text-blue-500 mr-2"></i>
                    <span class="font-medium text-gray-700">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:</span>
                </div>
                <a id="sourceLink" href="https://www.bcse.by/stock/securitydirectory/100345505/5-200-01-3593" target="_blank" class="text-blue-600 hover:text-blue-800 break-all">
                    https://www.bcse.by/stock/securitydirectory/100345505/5-200-01-3593
                </a>
                <div class="mt-2 text-xs text-blue-800/80">
                    –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∏–∑-–∑–∞ CORS –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –ø–æ–∑–≤–æ–ª–∏—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞–ø—Ä—è–º—É—é. –ï—Å–ª–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –≤–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é.
                </div>
            </div>

            <!-- Security Details -->
            <div class="space-y-6">

                <!-- Last Trade Date -->
                <div class="p-4 border border-gray-200 rounded-xl">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-calendar-alt text-purple-500 mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-800">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏</h3>
                    </div>
                    <div class="flex items-center flex-wrap gap-3">
                        <div class="text-3xl font-bold text-gray-900" id="lastTradeDate">17.12.2025</div>
                        <div class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                            <i class="fas fa-clock mr-1"></i> <span id="freshness">–ê–∫—Ç—É–∞–ª—å–Ω–æ</span>
                        </div>
                    </div>
                </div>

                <!-- Price Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Current Price -->
                    <div class="p-4 border border-gray-200 rounded-xl">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-money-bill-wave text-green-500 mr-3"></i>
                            <h3 class="text-lg font-semibold text-gray-800">–¶–µ–Ω–∞, BYN</h3>
                        </div>
                        <div class="text-3xl font-bold text-green-600"><span id="currentPrice">41.40</span></div>
                        <div class="text-sm text-gray-500 mt-1">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                    </div>

                    <!-- Change -->
                    <div class="p-4 border border-gray-200 rounded-xl">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-chart-bar text-orange-500 mr-3"></i>
                            <h3 class="text-lg font-semibold text-gray-800">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</h3>
                        </div>
                        <div class="flex items-center flex-wrap gap-3">
                            <div class="text-3xl font-bold text-orange-600"><span id="priceChange">9.40</span></div>
                            <div class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                                <i class="fas fa-arrow-up mr-1"></i> <span id="priceChangePercent">29.37%</span>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 mt-1">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã</div>
                    </div>
                </div>

                <!-- Secondary market results -->
                <div class="p-4 border border-gray-200 rounded-xl">
                    <div class="flex items-start justify-between gap-3 mb-4">
                        <div>
                            <div class="flex items-center">
                                <i class="fas fa-clipboard-list text-indigo-500 mr-3"></i>
                                <h3 class="text-lg font-semibold text-gray-800">–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ ‚Äî –∫—É–ø–ª—è/–ø—Ä–æ–¥–∞–∂–∞ (–≤—Ç–æ—Ä–∏—á–Ω—ã–π)</h3>
                            </div>
                            <div class="text-sm text-gray-500 mt-1">–¶–µ–Ω–∞, –≤–∞–ª. —Ü–µ–Ω–æ–æ–±—Ä.: –º–∏–Ω / –º–∞–∫—Å / —Å—Ä–≤–∑</div>
                            <div class="mt-2 text-xs text-blue-600 flex items-center gap-1">
                                <i class="fas fa-sync-alt animate-spin"></i>
                                <span>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ë–í–§–ë</span>
                            </div>
                        </div>
                        <button id="editSecondaryBtn" class="shrink-0 inline-flex items-center gap-2 text-sm px-3 py-2 rounded-xl border border-gray-200 text-gray-700 hover:bg-gray-50 transition">
                            <i class="fas fa-pen"></i>
                            –†—É—á–Ω–æ–π –≤–≤–æ–¥
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="p-3 rounded-xl bg-gray-50 border border-gray-200">
                            <div class="text-xs text-gray-500">–º–∏–Ω.</div>
                            <div class="text-2xl font-bold text-gray-900"><span id="secMin">‚Äî</span></div>
                        </div>
                        <div class="p-3 rounded-xl bg-gray-50 border border-gray-200">
                            <div class="text-xs text-gray-500">–º–∞–∫—Å.</div>
                            <div class="text-2xl font-bold text-gray-900"><span id="secMax">‚Äî</span></div>
                        </div>
                        <div class="p-3 rounded-xl bg-gray-50 border border-gray-200">
                            <div class="text-xs text-gray-500">—Å—Ä–≤–∑</div>
                            <div class="text-2xl font-bold text-gray-900"><span id="secAvg">‚Äî</span></div>
                        </div>
                    </div>

                    <div class="mt-3 text-xs text-gray-500">
                        ‚úÖ –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ¬´–ø–æ–¥—Ä–æ–±–Ω—ã–π¬ª —Ñ–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram.
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="p-4 gradient-bg text-white rounded-xl">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-info-circle text-white mr-3"></i>
                        <h3 class="text-lg font-semibold">–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    </div>
                    <p class="text-white/90" id="summaryText">
                        –¶–µ–Ω–Ω–∞—è –±—É–º–∞–≥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–æ—Å—Ç –Ω–∞ 29.37% —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ü–µ–Ω—ã –Ω–∞ 9.40 BYN.
                        –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞ –±—ã–ª–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ 16 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞ –ø–æ —Ü–µ–Ω–µ 41.40 BYN.
                    </p>
                </div>

            </div>
        </div>

        <!-- Right Column: Telegram Bot Configuration -->
        <div class="bg-white rounded-2xl card-shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fab fa-telegram text-blue-400 mr-2"></i>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ë–æ—Ç–∞
                </h2>
                <span class="bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full">
                    <i class="fas fa-bolt mr-1"></i> –ê–∫—Ç–∏–≤–Ω—ã–π
                </span>
            </div>

            <!-- Bot Status -->
            <div class="mb-8 p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3 pulse"></div>
                        <span class="font-medium text-gray-700">–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞:</span>
                    </div>
                    <span class="font-semibold text-green-600">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>
                </div>
                <p class="text-gray-600 text-sm">
                    –í–Ω–∏–º–∞–Ω–∏–µ: —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–≤ –±—Ä–∞—É–∑–µ—Ä–µ) ‚Äî —ç—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.
                    –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω—É–∂–Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å.
                </p>
            </div>

            <!-- Configuration Form -->
            <form id="botConfigForm" class="space-y-6">
                <!-- Telegram Chat ID -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">
                        <i class="fas fa-user-circle text-blue-500 mr-2"></i>
                        –í–∞—à Chat ID –≤ Telegram
                    </label>
                    <input type="text" id="chatId" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Chat ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789)"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                    <p class="text-gray-500 text-sm mt-2">
                        –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å Chat ID, –Ω–∞–ø–∏—à–∏—Ç–µ <span class="font-mono">/start</span> –±–æ—Ç—É
                        <span class="font-semibold text-blue-600">@userinfobot</span> –≤ Telegram
                    </p>
                </div>

                <!-- Notification Time -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">
                        <i class="fas fa-clock text-purple-500 mr-2"></i>
                        –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    </label>
                    <input type="time" id="notificationTime" value="09:00"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" required>
                    <p class="text-gray-500 text-sm mt-2">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</p>
                </div>

                <!-- Notification Format -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">
                        <i class="fas fa-edit text-green-500 mr-2"></i>
                        –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="format" value="short" checked class="mr-3">
                            <span>–ö—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="format" value="detailed" class="mr-3">
                            <span>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–≤–∫–ª—é—á–∞—è –∏—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤)</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit"
                            class="w-full gradient-bg text-white font-semibold py-3 px-6 rounded-xl hover:opacity-90 transition flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-3"></i>
                        –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </button>
                </div>
            </form>

            <!-- Bot Instructions -->
            <div class="mt-8 p-4 bg-blue-50 rounded-xl">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                    –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
                </h3>
                <ol class="list-decimal list-inside space-y-2 text-gray-600">
                    <li>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Chat ID –∏–∑ Telegram</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å¬ª (–≤–∞–º –ø—Ä–∏–¥—ë—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)</li>
                    <li>–î–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–π –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω—É–∂–Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (cron)</li>
                </ol>
            </div>

            <!-- Test Notification -->
            <div class="mt-6">
                <button id="testNotification"
                        class="w-full border-2 border-blue-500 text-blue-600 font-semibold py-3 px-6 rounded-xl hover:bg-blue-50 transition flex items-center justify-center">
                    <i class="fas fa-bell mr-3"></i>
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                </button>
            </div>

        </div>
    </div>

    <!-- Demo Notification Preview -->
    <div class="mt-12 bg-white rounded-2xl card-shadow p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-eye text-purple-500 mr-2"></i>
            –ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
        </h2>
        <div class="max-w-md mx-auto">
            <div class="bg-gray-100 rounded-2xl p-4">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div>
                        <div class="font-semibold">Stock Tracker Bot</div>
                        <div class="text-xs text-gray-500">–°–µ–≥–æ–¥–Ω—è, 09:00</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4">
                    <div class="font-bold text-lg mb-2">üìà –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ</div>
                    <div class="space-y-2">
                        <div><span class="font-medium">–î–∞—Ç–∞ —Å–¥–µ–ª–∫–∏:</span> <span id="previewDate">17.12.2025</span></div>
                        <div><span class="font-medium">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</span> <span id="previewPrice">41.40</span> BYN</div>
                        <div><span class="font-medium">–ò–∑–º–µ–Ω–µ–Ω–∏–µ:</span> +<span id="previewChange">9.40</span> BYN (+<span id="previewPercent">29.37%</span>)</div>
                        <div class="pt-2">
                            <div class="font-medium">–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á.):</div>
                            <div class="text-sm text-gray-700">
                                –º–∏–Ω. <span id="previewMin">‚Äî</span> ¬∑ –º–∞–∫—Å. <span id="previewMax">‚Äî</span> ¬∑ —Å—Ä–≤–∑ <span id="previewAvg">‚Äî</span>
                            </div>
                        </div>
                        <div class="pt-2 text-sm text-gray-500">–ò—Å—Ç–æ—á–Ω–∏–∫: –ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è –≤–∞–ª—é—Ç–Ω–æ-—Ñ–æ–Ω–¥–æ–≤–∞—è –±–∏—Ä–∂–∞</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 pt-8 border-t border-gray-200 text-center text-gray-600">
        <p><i class="fas fa-code mr-2"></i>–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ë–í–§–ë</p>
        <p class="text-sm mt-2">–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (cron)</p>
    </footer>

</div>

<!-- Secondary edit modal - Manual input -->
<div id="secondaryModal" class="hidden fixed inset-0 z-[100]">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white rounded-2xl card-shadow p-6">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">–†—É—á–Ω–æ–π –≤–≤–æ–¥ ¬´–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤¬ª</h3>
                    <p class="text-sm text-gray-500 mt-1">–ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é</p>
                </div>
                <button id="closeSecondaryModal" class="px-3 py-2 rounded-xl hover:bg-gray-100 transition" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>

            <div class="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                <div class="flex items-start gap-2 text-sm text-yellow-800">
                    <i class="fas fa-info-circle mt-0.5"></i>
                    <span>–û–±—ã—á–Ω–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞.</span>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–º–∏–Ω.</label>
                    <input id="secMinInput" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 41.40">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–º–∞–∫—Å.</label>
                    <input id="secMaxInput" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 41.40">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">—Å—Ä–≤–∑</label>
                    <input id="secAvgInput" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 41.40">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button id="saveSecondaryBtn" class="flex-1 gradient-bg text-white font-semibold py-3 px-6 rounded-xl hover:opacity-90 transition inline-flex items-center justify-center gap-2">
                    <i class="fas fa-floppy-disk"></i>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button id="clearSecondaryBtn" class="flex-1 border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-50 transition inline-flex items-center justify-center gap-2">
                    <i class="fas fa-eraser"></i>
                    –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Telegram Bot Configuration
    const BOT_TOKEN = '8206916174:AAG7lo_fCskXwyJiPEF9REbLL0kzgT6K20Q';
    const DEFAULT_CHAT_ID = '273298263';

    // Auto-send scheduler (browser-only demo)
    // Note: This will work only while the page is open in the browser.
    const AUTO_SEND_ENABLED_DEFAULT = true;
    const AUTO_SEND_TIME_MSK = '09:00';
    const AUTO_SEND_FORMAT = 'detailed';
    const AUTO_SEND_TZ = 'Europe/Moscow';

    // Data
    const securityData = {
        date: '17.12.2025',
        price: '41.40',
        change: '9.40',
        changePercent: '29.37%',
        source: 'https://www.bcse.by/stock/securitydirectory/100345505/5-200-01-3593',
        secondary: {
            min: '41.40',
            max: '41.40',
            avg: '41.40'
        },
        lastUpdatedIso: null
    };

    // DOM
    const form = document.getElementById('botConfigForm');
    const testBtn = document.getElementById('testNotification');
    const chatIdInput = document.getElementById('chatId');
    const sourceLink = document.getElementById('sourceLink');

    const lastUpdatedEl = document.getElementById('lastUpdated');
    const lastTradeDateEl = document.getElementById('lastTradeDate');
    const currentPriceEl = document.getElementById('currentPrice');
    const priceChangeEl = document.getElementById('priceChange');
    const priceChangePercentEl = document.getElementById('priceChangePercent');
    const summaryTextEl = document.getElementById('summaryText');

    const secMinEl = document.getElementById('secMin');
    const secMaxEl = document.getElementById('secMax');
    const secAvgEl = document.getElementById('secAvg');

    const previewDateEl = document.getElementById('previewDate');
    const previewPriceEl = document.getElementById('previewPrice');
    const previewChangeEl = document.getElementById('previewChange');
    const previewPercentEl = document.getElementById('previewPercent');
    const previewMinEl = document.getElementById('previewMin');
    const previewMaxEl = document.getElementById('previewMax');
    const previewAvgEl = document.getElementById('previewAvg');

    const refreshDataBtn = document.getElementById('refreshDataBtn');

    // Modal
    const secondaryModal = document.getElementById('secondaryModal');
    const editSecondaryBtn = document.getElementById('editSecondaryBtn');
    const closeSecondaryModal = document.getElementById('closeSecondaryModal');
    const saveSecondaryBtn = document.getElementById('saveSecondaryBtn');
    const clearSecondaryBtn = document.getElementById('clearSecondaryBtn');
    const secMinInput = document.getElementById('secMinInput');
    const secMaxInput = document.getElementById('secMaxInput');
    const secAvgInput = document.getElementById('secAvgInput');

    // Storage
    const STORAGE_KEY = 'bcse_stock_tracker_state_v2';

    // Scheduler state
    let autoSendEnabled = AUTO_SEND_ENABLED_DEFAULT;
    let lastAutoSendKey = null; // e.g. '2025-12-17'

    function loadState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const saved = JSON.parse(raw);
            if (saved?.secondary) {
                securityData.secondary.min = saved.secondary.min ?? securityData.secondary.min;
                securityData.secondary.max = saved.secondary.max ?? securityData.secondary.max;
                securityData.secondary.avg = saved.secondary.avg ?? securityData.secondary.avg;
            }
            if (saved?.lastUpdatedIso) securityData.lastUpdatedIso = saved.lastUpdatedIso;
            if (typeof saved?.autoSendEnabled === 'boolean') autoSendEnabled = saved.autoSendEnabled;
            if (saved?.lastAutoSendKey) lastAutoSendKey = saved.lastAutoSendKey;
        } catch (e) {
            // ignore
        }
    }

    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            secondary: securityData.secondary,
            lastUpdatedIso: securityData.lastUpdatedIso,
            autoSendEnabled,
            lastAutoSendKey
        }));
    }

    // UI render
    function render() {
        sourceLink.href = securityData.source;
        sourceLink.textContent = securityData.source;

        lastTradeDateEl.textContent = securityData.date;
        currentPriceEl.textContent = securityData.price;
        priceChangeEl.textContent = securityData.change;
        priceChangePercentEl.textContent = securityData.changePercent;

        secMinEl.textContent = securityData.secondary.min;
        secMaxEl.textContent = securityData.secondary.max;
        secAvgEl.textContent = securityData.secondary.avg;

        previewDateEl.textContent = securityData.date;
        previewPriceEl.textContent = securityData.price;
        previewChangeEl.textContent = securityData.change;
        previewPercentEl.textContent = securityData.changePercent;
        previewMinEl.textContent = securityData.secondary.min;
        previewMaxEl.textContent = securityData.secondary.max;
        previewAvgEl.textContent = securityData.secondary.avg;

        const pct = securityData.changePercent?.toString()?.replace('+', '');
        summaryTextEl.textContent = `–¶–µ–Ω–Ω–∞—è –±—É–º–∞–≥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ ${pct} —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ü–µ–Ω—ã –Ω–∞ ${securityData.change} BYN. –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞ –±—ã–ª–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ ${securityData.date} –ø–æ —Ü–µ–Ω–µ ${securityData.price} BYN.`;

        if (securityData.lastUpdatedIso) {
            lastUpdatedEl.textContent = new Date(securityData.lastUpdatedIso).toLocaleString('ru-RU');
        } else {
            lastUpdatedEl.textContent = '‚Äî';
        }
    }

    // Set default Chat ID
    chatIdInput.value = DEFAULT_CHAT_ID;

    // Telegram API
    async function sendTelegramMessage(chatId, message) {
        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'HTML',
                disable_web_page_preview: true
            })
        });
        return await response.json();
    }

    function normalizeNumber(s) {
        if (!s) return s;
        return String(s).replace(',', '.').trim();
    }

    function generateMessage(format) {
        const min = securityData.secondary.min;
        const max = securityData.secondary.max;
        const avg = securityData.secondary.avg;
        const hasSecondary = [min, max, avg].some(v => v && v !== '‚Äî');

        if (format === 'short') {
            return `üìà <b>–¶–µ–Ω–Ω–∞—è –±—É–º–∞–≥–∞ –ë–í–§–ë</b>\n\nüìÖ –î–∞—Ç–∞: ${securityData.date}\nüí∞ –¶–µ–Ω–∞: ${securityData.price} BYN\nüìä –ò–∑–º–µ–Ω–µ–Ω–∏–µ: +${securityData.change} BYN (+${securityData.changePercent})`;
        }

        return `üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ</b>\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìÖ <b>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏:</b> ${securityData.date}\nüí∞ <b>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</b> ${securityData.price} BYN\nüìä <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã:</b> +${securityData.change} BYN\nüìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:</b> +${securityData.changePercent}\n${hasSecondary ? `\nüßæ <b>–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á.):</b>\n‚Ä¢ –º–∏–Ω.: ${min}\n‚Ä¢ –º–∞–∫—Å.: ${max}\n‚Ä¢ —Å—Ä–≤–∑: ${avg}\n` : ''}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüîó <a href="${securityData.source}">–ò—Å—Ç–æ—á–Ω–∏–∫: –ë–í–§–ë</a>\n\n‚è∞ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
    }

    // Fetch/parse BCSE
    async function fetchWithFallback(url) {
        const proxyBuilders = [
            u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
            u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            u => `https://r.jina.ai/${u}`,
            u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`
        ];

        let lastErr = null;
        for (const build of proxyBuilders) {
            const proxied = build(url);
            try {
                const res = await fetch(proxied, { 
                    method: 'GET', 
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                if (!text || text.length < 500) throw new Error('–ü–æ—Ö–æ–∂–µ –Ω–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –ë–í–§–ë
                if (text.includes('bcse') || text.includes('–ë–í–§–ë') || text.includes('–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è –≤–∞–ª—é—Ç–Ω–æ-—Ñ–æ–Ω–¥–æ–≤–∞—è –±–∏—Ä–∂–∞')) {
                    return text;
                }
                
                return text;
            } catch (e) {
                lastErr = e;
                console.log(`Proxy ${proxied.substring(0, 30)}... failed:`, e.message);
            }
        }
        throw lastErr || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å');
    }

    function extractByRegex(text, regex) {
        const m = text.match(regex);
        return m && m[1] ? m[1].trim() : null;
    }

    function normalizeSecondaryValues(text) {
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–µ–≥–æ
        let cleanedText = text
            .replace(/\u00a0/g, ' ')
            .replace(/[\t\r]+/g, ' ')
            .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
            .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');

        const targetDate = '17.12.2025';
        console.log('üîç –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∞—Ç—É:', targetDate);

        // –ü–∞—Ç—Ç–µ—Ä–Ω: 17.12.2025 ... –ù–î–ê ... SCCP-T0 ... BYN ... —Ç—Ä–∏ —á–∏—Å–ª–∞ (–º–∏–Ω, –º–∞–∫—Å, —Å—Ä–≤–∑)
        // –ü–æ–∏—Å–∫ –≤ —Å—Ç—Ä–æ–∫–µ —Ç–∞–±–ª–∏—Ü—ã
        const tableRowPattern = new RegExp(
            `17\\.12\\.2025[\\s\\S]{0,300}?(?:–ù–î–ê|SCCP-T0)[\\s\\S]{0,200}?BYN[\\s\\S]{0,300}?([0-9]+(?:[.,][0-9]{1,2})?)[\\s\\S]{0,150}?([0-9]+(?:[.,][0-9]{1,2})?)[\\s\\S]{0,150}?([0-9]+(?:[.,][0-9]{1,2})?)`,
            'gi'
        );

        const tableMatch = cleanedText.match(tableRowPattern);
        if (tableMatch && tableMatch[0]) {
            const fullMatch = tableMatch[0];
            console.log('üìä –ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã:', fullMatch.substring(0, 100) + '...');
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç—Ä–∏ —á–∏—Å–ª–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
            const numbersPattern = /([0-9]+(?:[.,][0-9]{1,2})?)/g;
            const numbers = fullMatch.match(numbersPattern);
            
            if (numbers && numbers.length >= 3) {
                // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∏ —á–∏—Å–ª–∞ - —ç—Ç–æ –º–∏–Ω, –º–∞–∫—Å, —Å—Ä–≤–∑
                const min = normalizeNumber(numbers[numbers.length - 3]);
                const max = normalizeNumber(numbers[numbers.length - 2]);
                const avg = normalizeNumber(numbers[numbers.length - 1]);
                
                console.log('‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤ –Ω–∞ 17.12.2025:');
                console.log('  –º–∏–Ω:', min);
                console.log('  –º–∞–∫—Å:', max);
                console.log('  —Å—Ä–≤–∑:', avg);
                
                return { min, max, avg };
            }
        }

        console.log('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–∞ 17.12.2025 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ, –ø—ã—Ç–∞—é—Å—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã...');
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫: –±–ª–æ–∫ "–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤"
        const patterns = [
            /–∏—Ç–æ–≥–∏\s+—Ç–æ—Ä–≥–æ–≤[\s\S]{0,500}?–∫—É–ø–ª—è[\s\S]{0,300}?–ø—Ä–æ–¥–∞–∂–∞[\s\S]{0,300}?–≤—Ç–æ—Ä–∏—á[\s\S]{0,500}?([0-9]+(?:[.,][0-9]{1,2})?)\s+([0-9]+(?:[.,][0-9]{1,2})?)\s+([0-9]+(?:[.,][0-9]{1,2})?)/i,
            /–≤—Ç–æ—Ä–∏—á[\s\S]{0,200}?([0-9]+(?:[.,][0-9]{1,2})?)\s+([0-9]+(?:[.,][0-9]{1,2})?)\s+([0-9]+(?:[.,][0-9]{1,2})?)/i
        ];

        for (const pattern of patterns) {
            const match = cleanedText.match(pattern);
            if (match) {
                console.log('üìã –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É');
                return {
                    min: normalizeNumber(match[1]),
                    max: normalizeNumber(match[2]),
                    avg: normalizeNumber(match[3])
                };
            }
        }

        console.log('‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
        return null;
    }

    function parseBcseText(text) {
        const clean = text
            .replace(/\u00a0/g, ' ')
            .replace(/[\t\r]+/g, ' ')
            .replace(/\n{2,}/g, '\n')
            .trim();

        // Date
        const date = extractByRegex(clean, /–î–∞—Ç–∞\s+–ø–æ—Å–ª–µ–¥–Ω–µ–π\s+—Å–¥–µ–ª–∫–∏\s*([0-9]{2}\.[0-9]{2}\.[0-9]{4})/i);

        // Price
        const price = extractByRegex(clean, /–¶–µ–Ω–∞\s*,\s*BYN\s*([0-9]+(?:[\.,][0-9]+)?)/i);

        // Change + percent (best effort)
        const change = extractByRegex(clean, /–ò–∑–º–µ–Ω–µ–Ω–∏–µ\s*([+\-]?[0-9]+(?:[\.,][0-9]+)?)/i);
        const changePercent = extractByRegex(clean, /–ò–∑–º–µ–Ω–µ–Ω–∏–µ[\s\S]{0,120}?([+\-]?[0-9]+(?:[\.,][0-9]+)?%)/i);

        // Secondary results - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        const secondary = normalizeSecondaryValues(clean);

        return {
            date: date || null,
            price: price ? normalizeNumber(price) : null,
            change: change ? normalizeNumber(change) : null,
            changePercent: changePercent ? changePercent.replace(',', '.').trim() : null,
            secondary
        };
    }

    async function refreshFromBcse() {
        refreshDataBtn.disabled = true;
        const prev = refreshDataBtn.innerHTML;
        refreshDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            console.log('üåê –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ë–í–§–ë...');
            const html = await fetchWithFallback(securityData.source);

            // Parse as text (works for both HTML and proxied text)
            const parsed = parseBcseText(html);

            let updated = false;
            let updatedFields = [];

            if (parsed.date) {
                securityData.date = parsed.date;
                updated = true;
                updatedFields.push('–¥–∞—Ç–∞');
            }
            if (parsed.price) {
                securityData.price = parsed.price;
                updated = true;
                updatedFields.push('—Ü–µ–Ω–∞');
            }
            if (parsed.change) {
                securityData.change = parsed.change;
                updated = true;
                updatedFields.push('–∏–∑–º–µ–Ω–µ–Ω–∏–µ');
            }
            if (parsed.changePercent) {
                securityData.changePercent = parsed.changePercent;
                updated = true;
                updatedFields.push('–ø—Ä–æ—Ü–µ–Ω—Ç');
            }
            if (parsed.secondary) {
                securityData.secondary = parsed.secondary;
                updated = true;
                updatedFields.push('–∏—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤');
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', parsed.secondary);
            }

            if (updated) {
                securityData.lastUpdatedIso = new Date().toISOString();
                saveState();
                render();
                
                const message = `‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${updatedFields.join(', ')}`;
                console.log(message);
            } else {
                console.warn('‚ö†Ô∏è –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
            }
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e.message);
        } finally {
            refreshDataBtn.disabled = false;
            refreshDataBtn.innerHTML = prev;
        }
    }

    // Form submit
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const chatId = chatIdInput.value.trim();
        const time = document.getElementById('notificationTime').value;
        const format = document.querySelector('input[name="format"]:checked').value;

        if (!chatId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Chat ID');
            return;
        }

        const activationMessage = `‚úÖ <b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!</b>\n\n–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å ${format === 'short' ? '–∫—Ä–∞—Ç–∫–∏–µ' : '–ø–æ–¥—Ä–æ–±–Ω—ã–µ'} –æ—Ç—á–µ—Ç—ã –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ ${time}\n\nüìà –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–∞—è —Ü–µ–Ω–Ω–∞—è –±—É–º–∞–≥–∞:\nüîó ${securityData.source}`;

        try {
            showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...', 'info');
            const result = await sendTelegramMessage(chatId, activationMessage);

            if (result.ok) {
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram!', 'success');
                document.querySelectorAll('.success-message').forEach(el => el.remove());

                const successMessage = `
                    <div class="success-message mt-4 p-4 bg-green-50 border border-green-200 rounded-xl">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold text-green-800">‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>
                                <div class="text-green-600 text-sm mt-1">
                                    –ë–æ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å ${format === 'short' ? '–∫—Ä–∞—Ç–∫–∏–µ' : '–ø–æ–¥—Ä–æ–±–Ω—ã–µ'} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ ${time} –Ω–∞ Chat ID: ${chatId}
                                </div>
                                <div class="text-green-600 text-sm mt-1">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram ‚Äî –≤–∞–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</div>
                            </div>
                        </div>
                    </div>
                `;
                form.insertAdjacentHTML('afterend', successMessage);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + (result.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
        }
    });

    // Test notification
    testBtn.addEventListener('click', async function() {
        const chatId = chatIdInput.value.trim();
        const format = document.querySelector('input[name="format"]:checked').value;

        if (!chatId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Chat ID');
            return;
        }

        const message = generateMessage(format);

        try {
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>–û—Ç–ø—Ä–∞–≤–∫–∞...';

            showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
            const result = await sendTelegramMessage(chatId, message);

            if (result.ok) {
                showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
                document.querySelectorAll('.test-message').forEach(el => el.remove());

                const demoNotification = `
                    <div class="test-message mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <div class="flex items-center">
                            <i class="fab fa-telegram text-blue-500 text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold text-blue-800">‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</div>
                                <div class="text-blue-600 text-sm mt-1">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ Chat ID: ${chatId}</div>
                            </div>
                        </div>
                    </div>
                `;
                testBtn.insertAdjacentHTML('afterend', demoNotification);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + (result.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
        } finally {
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="fas fa-bell mr-3"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
        }
    });

    // Helpers
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-xl shadow-lg z-50 transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-3"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-10px)';
            setTimeout(() => notification.remove(), 300);
        }, 3200);
    }

    // Update time display label
    const timeInput = document.getElementById('notificationTime');
    timeInput.addEventListener('change', function() {
        const btn = document.querySelector('button[type="submit"]');
        if (btn) {
            btn.innerHTML = `<i class="fas fa-paper-plane mr-3"></i>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ ${this.value}`;
        }
    });

    // Modal logic
    function openSecondaryModal() {
        secMinInput.value = securityData.secondary.min === '‚Äî' ? '' : securityData.secondary.min;
        secMaxInput.value = securityData.secondary.max === '‚Äî' ? '' : securityData.secondary.max;
        secAvgInput.value = securityData.secondary.avg === '‚Äî' ? '' : securityData.secondary.avg;
        secondaryModal.classList.remove('hidden');
    }

    function closeSecondaryModalFn() {
        secondaryModal.classList.add('hidden');
    }

    editSecondaryBtn.addEventListener('click', openSecondaryModal);
    closeSecondaryModal.addEventListener('click', closeSecondaryModalFn);
    secondaryModal.addEventListener('click', (e) => {
        if (e.target === secondaryModal.firstElementChild) closeSecondaryModalFn();
    });

    saveSecondaryBtn.addEventListener('click', () => {
        const min = normalizeNumber(secMinInput.value);
        const max = normalizeNumber(secMaxInput.value);
        const avg = normalizeNumber(secAvgInput.value);

        securityData.secondary.min = min || '‚Äî';
        securityData.secondary.max = max || '‚Äî';
        securityData.secondary.avg = avg || '‚Äî';
        securityData.lastUpdatedIso = new Date().toISOString();

        saveState();
        render();
        closeSecondaryModalFn();
        showNotification('–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.', 'success');
    });

    clearSecondaryBtn.addEventListener('click', () => {
        securityData.secondary = { min: '‚Äî', max: '‚Äî', avg: '‚Äî' };
        securityData.lastUpdatedIso = new Date().toISOString();
        saveState();
        render();
        showNotification('–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ –æ—á–∏—â–µ–Ω—ã.', 'info');
        closeSecondaryModalFn();
    });

    refreshDataBtn.addEventListener('click', refreshFromBcse);

    // =========================
    // Auto-send scheduler (MSK)
    // =========================
    function getMskParts(date = new Date()) {
        const fmt = new Intl.DateTimeFormat('ru-RU', {
            timeZone: AUTO_SEND_TZ,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        const parts = fmt.formatToParts(date).reduce((acc, p) => {
            if (p.type !== 'literal') acc[p.type] = p.value;
            return acc;
        }, {});
        // parts: year, month, day, hour, minute
        const ymd = `${parts.year}-${parts.month}-${parts.day}`;
        const hm = `${parts.hour}:${parts.minute}`;
        return { ymd, hm };
    }

    function getMskWeekday(date = new Date()) {
        // 1..7 (Mon..Sun)
        const fmt = new Intl.DateTimeFormat('en-US', { timeZone: AUTO_SEND_TZ, weekday: 'short' });
        const w = fmt.format(date);
        const map = { Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6, Sun: 7 };
        return map[w] || 0;
    }

    function isWorkdayMsk(date = new Date()) {
        const wd = getMskWeekday(date);
        return wd >= 1 && wd <= 5;
    }

    async function maybeAutoSend() {
        if (!autoSendEnabled) return;

        const { ymd, hm } = getMskParts(new Date());
        if (!isWorkdayMsk(new Date())) return;

        // Send once per MSK day
        if (lastAutoSendKey === ymd) return;

        if (hm !== AUTO_SEND_TIME_MSK) return;

        try {
            // refresh data before sending
            await refreshFromBcse();
            const msg = generateMessage(AUTO_SEND_FORMAT);
            const result = await sendTelegramMessage(DEFAULT_CHAT_ID, msg);
            if (result?.ok) {
                lastAutoSendKey = ymd;
                saveState();
                showNotification(`–ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–ú–°–ö ${AUTO_SEND_TIME_MSK}).`, 'success');
            } else {
                showNotification('–ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞: –æ—à–∏–±–∫–∞ Telegram: ' + (result?.description || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
            }
        } catch (e) {
            showNotification('–ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞: –æ—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    }

    function startScheduler() {
        // check immediately and then periodically
        maybeAutoSend();
        setInterval(maybeAutoSend, 20 * 1000);
    }

    // Init
    loadState();

    // Force defaults for the requested behavior (weekday 09:00 MSK, detailed)
    document.querySelector('input[name="format"][value="detailed"]').checked = true;
    document.getElementById('notificationTime').value = AUTO_SEND_TIME_MSK;
    chatIdInput.value = DEFAULT_CHAT_ID;

    render();

    // Auto-load data on page load immediately
    console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ë–í–§–ë –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
    refreshFromBcse();

    // Start browser-only scheduler
    startScheduler();
});
</script>

</body>
</html>