<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram –ë–æ—Ç - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥–∞—Ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .mobile-full {
                width: 100% !important;
            }
            .mobile-stack {
                flex-direction: column !important;
            }
            .mobile-center {
                text-align: center !important;
            }
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fab fa-telegram text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Telegram –ë–æ—Ç</h1>
                        <p class="text-sm opacity-90">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥–∞—Ö</p>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-2 text-sm">
                    <span id="currentTime" class="bg-white/20 px-3 py-1 rounded-full"></span>
                    <span id="connectionStatus" class="bg-green-500 px-3 py-1 rounded-full flex items-center">
                        <i class="fas fa-circle text-xs mr-1"></i> –ê–∫—Ç–∏–≤–Ω–æ
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Stock Info -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Stock Info Card -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ
                        </h2>
                        <button id="refreshFromBcse" class="text-purple-600 hover:text-purple-700 transition-colors">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å –ë–í–§–ë
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏</p>
                            <p id="stockDate" class="text-lg font-semibold text-gray-800">17.12.2025</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</p>
                            <p id="stockPrice" class="text-lg font-semibold text-gray-800">41.40 BYN</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã</p>
                            <p id="stockChange" class="text-lg font-semibold text-green-600">+9.40 BYN</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-1">–ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>
                            <p id="stockChangePercent" class="text-lg font-semibold text-blue-600">+29.37%</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-purple-50 rounded-lg">
                        <a href="https://www.bcse.by/stock/securitydirectory/100345505/5-200-01-3593" 
                           target="_blank" 
                           class="text-purple-600 hover:text-purple-700 text-sm flex items-center">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            –ò—Å—Ç–æ—á–Ω–∏–∫: –ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è –≤–∞–ª—é—Ç–Ω–æ-—Ñ–æ–Ω–¥–æ–≤–∞—è –±–∏—Ä–∂–∞
                        </a>
                    </div>
                </div>

                <!-- Secondary Market Info -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-exchange-alt text-purple-600 mr-2"></i>
                            –ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ ‚Äî –∫—É–ø–ª—è/–ø—Ä–æ–¥–∞–∂–∞ (–≤—Ç–æ—Ä–∏—á–Ω—ã–π)
                        </h2>
                        <button id="editSecondaryBtn" class="text-purple-600 hover:text-purple-700 transition-colors">
                            <i class="fas fa-edit"></i> –†—É—á–Ω–æ–π –≤–≤–æ–¥
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-gray-600 mb-2">–¶–µ–Ω–∞, –≤–∞–ª. —Ü–µ–Ω–æ–æ–±—Ä.: –º–∏–Ω / –º–∞–∫—Å / —Å—Ä–≤–∑</p>
                        <div class="text-xs text-gray-500 mb-3" id="secondaryStatus">
                            <i class="fas fa-info-circle"></i> –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ë–í–§–ë
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-xs text-gray-600 mb-1">–º–∏–Ω.</p>
                                <p id="secondaryMin" class="text-lg font-semibold text-gray-800">‚Äî</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600 mb-1">–º–∞–∫—Å.</p>
                                <p id="secondaryMax" class="text-lg font-semibold text-gray-800">‚Äî</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-600 mb-1">—Å—Ä–≤–∑</p>
                                <p id="secondaryAvg" class="text-lg font-semibold text-gray-800">‚Äî</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-info-circle"></i> –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ¬´–ø–æ–¥—Ä–æ–±–Ω—ã–π¬ª —Ñ–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram.
                    </div>
                </div>
            </div>

            <!-- Right Column - Bot Settings -->
            <div class="space-y-6">
                <!-- Bot Settings Card -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-robot text-purple-600 mr-2"></i>
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –±–æ—Ç–∞
                    </h2>
                    
                    <form id="botSettingsForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Chat ID
                            </label>
                            <input type="text" 
                                   id="chatId" 
                                   value="273298263"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ Chat ID">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                –í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                            </label>
                            <input type="time" 
                                   id="notificationTime" 
                                   value="09:00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            </label>
                            <select id="notificationFormat" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="brief">–ö—Ä–∞—Ç–∫–∏–π</option>
                                <option value="detailed" selected>–ü–æ–¥—Ä–æ–±–Ω—ã–π</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="autoSendEnabled" 
                                   checked
                                   class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <label for="autoSendEnabled" class="ml-2 text-sm text-gray-700">
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ 09:00 –ú–°–ö (–±—É–¥–Ω–∏)
                            </label>
                        </div>
                    </form>
                </div>

                <!-- Actions Card -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-play-circle text-purple-600 mr-2"></i>
                        –î–µ–π—Å—Ç–≤–∏—è
                    </h2>
                    
                    <div class="space-y-3">
                        <button id="testNotification" 
                                class="w-full btn-primary text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        </button>
                        
                        <button id="activateBot" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        </button>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-6 text-white">
                    <h3 class="text-lg font-semibold mb-3">
                        <i class="fas fa-info-circle mr-2"></i>
                        –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞:</span>
                            <span id="lastSent">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span>–°–ª–µ–¥—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:</span>
                            <span id="nextSend">‚Äî</span>
                        </div>
                        <div class="flex justify-between">
                            <span>–°—Ç–∞—Ç—É—Å:</span>
                            <span class="flex items-center">
                                <i class="fas fa-circle text-xs mr-1 pulse-animation"></i>
                                –ê–∫—Ç–∏–≤–µ–Ω
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demo Preview -->
        <div class="mt-8 bg-white rounded-xl card-shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-eye text-purple-600 mr-2"></i>
                –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            </h2>
            <div id="notificationPreview" class="bg-gray-50 rounded-lg p-4 font-mono text-sm">
                <div class="text-gray-600">
                    üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ</b><br>
                    ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ<br>
                    üìÖ <b>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏:</b> 17.12.2025<br>
                    üí∞ <b>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</b> 41.40 BYN<br>
                    üìä <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã:</b> +9.40 BYN<br>
                    üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:</b> +29.37%<br>
                    <br>
                    üßæ <b>–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á.):</b><br>
                    ‚Ä¢ –º–∏–Ω.: 41.40<br>
                    ‚Ä¢ –º–∞–∫—Å.: 41.40<br>
                    ‚Ä¢ —Å—Ä–≤–∑: 41.40<br>
                    ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ<br>
                    üîó <a href="#">–ò—Å—Ç–æ—á–Ω–∏–∫: –ë–í–§–ë</a><br>
                    ‚è∞ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: <span id="previewTime"></span>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Secondary Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ —Ç–æ—Ä–≥–æ–≤</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–º–∏–Ω.</label>
                    <input type="text" id="editMin" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–º–∞–∫—Å.</label>
                    <input type="text" id="editMax" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">—Å—Ä–≤–∑</label>
                    <input type="text" id="editAvg" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="saveSecondary" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button id="cancelEdit" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        // Telegram Bot Configuration
        const BOT_TOKEN = '8206916174:AAG7lo_fCskXwyJiPEF9REbLL0kzgT6K20Q';
        const STOCK_URL = 'https://www.bcse.by/stock/securitydirectory/100345505/5-200-01-3593';
        
        // State management
        let state = {
            chatId: '273298263',
            notificationTime: '09:00',
            notificationFormat: 'detailed',
            autoSendEnabled: true,
            lastAutoSendKey: null,
            stockData: {
                date: '17.12.2025',
                price: '41.40',
                change: '9.40',
                changePercent: '29.37%',
                secondary: {
                    min: '41.40',
                    max: '41.40',
                    avg: '41.40'
                }
            }
        };

        // Load state from localStorage
        function loadState() {
            const saved = localStorage.getItem('telegramBotState');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
                updateUI();
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('telegramBotState', JSON.stringify(state));
        }

        // Update UI with current state
        function updateUI() {
            document.getElementById('chatId').value = state.chatId;
            document.getElementById('notificationTime').value = state.notificationTime;
            document.getElementById('notificationFormat').value = state.notificationFormat;
            document.getElementById('autoSendEnabled').checked = state.autoSendEnabled;
            
            // Update stock data
            document.getElementById('stockDate').textContent = state.stockData.date;
            document.getElementById('stockPrice').textContent = state.stockData.price + ' BYN';
            document.getElementById('stockChange').textContent = '+' + state.stockData.change + ' BYN';
            document.getElementById('stockChangePercent').textContent = '+' + state.stockData.changePercent;
            
            // Update secondary data
            document.getElementById('secondaryMin').textContent = state.stockData.secondary.min;
            document.getElementById('secondaryMax').textContent = state.stockData.secondary.max;
            document.getElementById('secondaryAvg').textContent = state.stockData.secondary.avg;
            
            updateNotificationPreview();
        }

        // Update notification preview
        function updateNotificationPreview() {
            const format = state.notificationFormat;
            let message = '';
            
            if (format === 'brief') {
                message = `üìà ${state.stockData.date}: ${state.stockData.price} BYN (${state.stockData.changePercent})`;
            } else {
                message = `üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ <b>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏:</b> ${state.stockData.date}
üí∞ <b>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</b> ${state.stockData.price} BYN
üìä <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã:</b> +${state.stockData.change} BYN
üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:</b> +${state.stockData.changePercent}

üßæ <b>–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á.):</b>
‚Ä¢ –º–∏–Ω.: ${state.stockData.secondary.min}
‚Ä¢ –º–∞–∫—Å.: ${state.stockData.secondary.max}
‚Ä¢ —Å—Ä–≤–∑: ${state.stockData.secondary.avg}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîó <a href="${STOCK_URL}">–ò—Å—Ç–æ—á–Ω–∏–∫: –ë–í–§–ë</a>

‚è∞ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
            }
            
            document.getElementById('notificationPreview').innerHTML = message;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast bg-white rounded-lg shadow-lg p-4 flex items-center space-x-3 ${
                type === 'success' ? 'border-l-4 border-green-500' : 
                type === 'error' ? 'border-l-4 border-red-500' : 
                'border-l-4 border-blue-500'
            }`;
            
            const icon = type === 'success' ? 'fa-check-circle text-green-500' : 
                         type === 'error' ? 'fa-exclamation-circle text-red-500' : 
                         'fa-info-circle text-blue-500';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-xl"></i>
                <span class="text-gray-700">${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Send message to Telegram
        async function sendTelegramMessage(chatId, message) {
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    return { success: true, data };
                } else {
                    return { success: false, error: data.description };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Parse BCSE data with improved methods
        async function parseBcseData(html) {
            console.log('üîç –ù–∞—á–∏–Ω–∞—é –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö...');

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Helpers
            const norm = (s) => (s || '').replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
            const normNum = (s) => {
                const m = norm(s).match(/(\d+[.,]\d{2})/);
                return m ? m[1].replace(',', '.') : null;
            };
            const isMoney = (s) => /^\d+\.\d{2}$/.test(s);

            let date = state?.stockData?.date || '‚Äî';
            let price = state?.stockData?.price || '‚Äî';
            let min = state?.stockData?.secondary?.min || '‚Äî';
            let max = state?.stockData?.secondary?.max || '‚Äî';
            let avg = state?.stockData?.secondary?.avg || '‚Äî';

            let parseMeta = { dateSource: 'fallback', priceSource: 'fallback', secondarySource: 'fallback' };

            try {
                // Helpers: –¥–∞—Ç–∞
                const parseRuDate = (s) => {
                    const m = norm(s).match(/(\d{2})\.(\d{2})\.(\d{4})/);
                    if (!m) return null;
                    const [_, dd, mm, yyyy] = m;
                    const d = new Date(Date.UTC(parseInt(yyyy, 10), parseInt(mm, 10) - 1, parseInt(dd, 10), 12, 0, 0));
                    return { str: `${dd}.${mm}.${yyyy}`, d };
                };
                const nowMsk = () => new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/Moscow' }));
                const isFutureRuDate = (ruDateStr) => {
                    const parsed = parseRuDate(ruDateStr);
                    if (!parsed) return false;
                    const n = nowMsk();
                    // –¥–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å: +1 –¥–µ–Ω—å (–∏–∑-–∑–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤/–ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
                    const max = new Date(n);
                    max.setDate(max.getDate() + 1);
                    return parsed.d.getTime() > max.getTime();
                };

                // 0) –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–∞–º—É—é —Å–≤–µ–∂—É—é –¥–∞—Ç—É –ø—Ä—è–º–æ –≤ —Å—Ç—Ä–æ–∫–∞—Ö —Ç–∞–±–ª–∏—Ü —Ç–æ—Ä–≥–æ–≤ (–ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —á–∞—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç—É)
                // –≠—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º ¬´–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏¬ª, –µ—Å–ª–∏ –ø—Ä–æ–∫—Å–∏/—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–¥–∞—é—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç.
                const rows = Array.from(doc.querySelectorAll('tr'));
                let bestTradeRow = null;
                let bestTradeDate = null;

                for (const row of rows) {
                    const cells = Array.from(row.querySelectorAll('td,th')).map(td => norm(td.textContent));
                    if (cells.length < 5) continue;
                    const bynIdx = cells.findIndex(c => /^BYN$/i.test(c));
                    if (bynIdx === -1) continue;

                    // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≥–¥–µ-—Ç–æ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
                    const dateCell = cells.find(c => /\d{2}\.\d{2}\.\d{4}/.test(c));
                    const parsed = dateCell ? parseRuDate(dateCell) : null;
                    if (!parsed) continue;
                    if (isFutureRuDate(parsed.str)) continue;

                    // –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã 3 —Ü–µ–Ω –ø–æ—Å–ª–µ BYN
                    const after = cells.slice(bynIdx + 1).map(c => c.replace(',', '.'));
                    const money = after.filter(v => isMoney(v));
                    if (money.length < 3) continue;

                    if (!bestTradeDate || parsed.d.getTime() > bestTradeDate.d.getTime()) {
                        bestTradeDate = parsed;
                        bestTradeRow = { cells, money };
                    }
                }

                if (bestTradeDate && bestTradeRow) {
                    date = bestTradeDate.str;
                    parseMeta.dateSource = 'tradeTable:maxDateRow';
                }

                // 1) –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ —É—Ç–æ—á–Ω–µ–Ω–∏–µ/—Ñ–æ–ª–±—ç–∫, –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –æ–Ω–∞ ¬´–≤ –±—É–¥—É—â–µ–º¬ª)
                const dateLabel = Array.from(doc.querySelectorAll('td, th, span, div'))
                    .find(el => /–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏/i.test(norm(el.textContent)));
                if (dateLabel) {
                    let candidate = null;

                    if (dateLabel.tagName && /TD|TH/.test(dateLabel.tagName)) {
                        const row = dateLabel.closest('tr');
                        if (row) {
                            const cells = Array.from(row.querySelectorAll('td,th'));
                            const idx = cells.indexOf(dateLabel);
                            if (idx >= 0 && cells[idx + 1]) candidate = norm(cells[idx + 1].textContent);
                        }
                        if (!candidate && dateLabel.nextElementSibling) candidate = norm(dateLabel.nextElementSibling.textContent);
                    } else {
                        if (dateLabel.nextElementSibling) candidate = norm(dateLabel.nextElementSibling.textContent);
                    }

                    const parsed = candidate ? parseRuDate(candidate) : null;
                    if (parsed && !isFutureRuDate(parsed.str)) {
                        // –ï—Å–ª–∏ tradeTable —É–∂–µ –¥–∞–ª–∞ –¥–∞—Ç—É, –æ—Å—Ç–∞–≤–ª—è–µ–º –±–æ–ª–µ–µ —Å–≤–µ–∂—É—é/–∞–¥–µ–∫–≤–∞—Ç–Ω—É—é
                        if (!date || date === '‚Äî') {
                            date = parsed.str;
                            parseMeta.dateSource = 'label:–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏';
                        } else {
                            const cur = parseRuDate(date);
                            if (!cur || parsed.d.getTime() >= cur.d.getTime()) {
                                date = parsed.str;
                                parseMeta.dateSource = 'label:–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏ (override)';
                            }
                        }
                    }
                }

                // 2) –ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á–Ω—ã–π) –ø–æ —Å—Ç—Ä–æ–∫–µ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∞—Ç–æ–π –∏ BYN
                // –≠—Ç–æ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ ¬´—Ü–µ–Ω–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É¬ª (—Å—Ä–≤–∑/–º–∞–∫—Å/–º–∏–Ω)
                const candidates = [];

                for (const row of rows) {
                    const rowText = norm(row.textContent);
                    if (!date || date === '‚Äî') continue;
                    if (!rowText.includes(date)) continue;
                    if (!/\bBYN\b/.test(rowText)) continue;

                    const cells = Array.from(row.querySelectorAll('td,th')).map(td => norm(td.textContent));
                    const bynIdx = cells.findIndex(c => /^BYN$/i.test(c));
                    if (bynIdx === -1) continue;

                    const after = cells.slice(bynIdx + 1).map(c => c.replace(',', '.'));
                    const money = after.filter(v => isMoney(v));
                    if (money.length >= 3) {
                        candidates.push({ money, cells });
                    }
                }

                // –µ—Å–ª–∏ candidates –ø—É—Å—Ç, –Ω–æ –µ—Å—Ç—å bestTradeRow (–¥–ª—è —Å–∞–º–æ–π —Å–≤–µ–∂–µ–π –¥–∞—Ç—ã) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (!candidates.length && bestTradeRow && bestTradeDate && bestTradeDate.str === date) {
                    candidates.push(bestTradeRow);
                    parseMeta.secondarySource = 'tradeTable:maxDateRow (direct)';
                }

                if (candidates.length) {
                    candidates.sort((a, b) => b.money.length - a.money.length);
                    const best = candidates[0];

                    // –ù–∞ –ë–í–§–ë –ø–æ—Å–ª–µ BYN –æ–±—ã—á–Ω–æ –∏–¥—É—Ç: –º–∏–Ω / –º–∞–∫—Å / —Å—Ä–≤–∑ (–∏–Ω–æ–≥–¥–∞ –µ—â–µ –æ–±—ä–µ–º—ã ‚Äî –ø–æ—ç—Ç–æ–º—É –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 ¬´–¥–µ–Ω–µ–∂–Ω—ã—Ö¬ª)
                    min = best.money[0];
                    max = best.money[1];
                    avg = best.money[2];
                    parseMeta.secondarySource = parseMeta.secondarySource || `row:${date}+BYN (moneyAfterBYN=${best.money.length})`;

                    // –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —ç—Ç–æ–π –∂–µ —Ç–æ—Ä–≥–æ–≤–æ–π –¥–∞—Ç–µ.
                    // –ë–µ—Ä—ë–º —Å—Ä–≤–∑ (–µ—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–∞), –∏–Ω–∞—á–µ –º–∞–∫—Å/–º–∏–Ω.
                    if (avg && isMoney(avg)) {
                        price = avg;
                        parseMeta.priceSource = 'secondary:avg (price on last trade date)';
                    } else if (max && isMoney(max)) {
                        price = max;
                        parseMeta.priceSource = 'secondary:max (price on last trade date)';
                    } else if (min && isMoney(min)) {
                        price = min;
                        parseMeta.priceSource = 'secondary:min (price on last trade date)';
                    }
                } else {
                    // fallback: –ø–ª–æ—Å–∫–∏–π —Ç–µ–∫—Å—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –¥–∞—Ç—ã
                    const text = norm(doc.body ? doc.body.textContent : doc.textContent);
                    if (date && text.includes(date)) {
                        const idx = text.indexOf(date);
                        const windowText = text.slice(idx, idx + 900);
                        // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç–∞ XX.XX, —á—Ç–æ–±—ã –Ω–µ —Å—Ö–≤–∞—Ç–∏—Ç—å —á–∞—Å—Ç–∏ –¥–∞—Ç—ã
                        const nums = (windowText.match(/\b\d+[.,]\d{2}\b/g) || []).map(x => x.replace(',', '.'));
                        if (nums.length >= 3) {
                            min = nums[0];
                            max = nums[1];
                            avg = nums[2];
                            parseMeta.secondarySource = 'textWindowAfterDate';

                            price = avg;
                            parseMeta.priceSource = 'textWindow:avg (price on last trade date)';
                        }
                    }
                }

                // 3) –†–µ–∑–µ—Ä–≤: ¬´–¶–µ–Ω–∞, BYN¬ª –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É —Ç–æ—Ä–≥–æ–≤.
                // –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ¬´–¶–µ–Ω–∞, BYN¬ª –≤ —Ä–∞–∑–Ω—ã—Ö –±–ª–æ–∫–∞—Ö, –ø–æ—ç—Ç–æ–º—É –±–µ–∑ —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Ç–µ–º.
                if ((!price || price === '‚Äî') && (!min || min === '‚Äî') && (!max || max === '‚Äî') && (!avg || avg === '‚Äî')) {
                    const priceLabel = Array.from(doc.querySelectorAll('td, th, span, div'))
                        .find(el => /–¶–µ–Ω–∞,\s*BYN/i.test(norm(el.textContent)));
                    if (priceLabel) {
                        let candidateCell = null;
                        if (priceLabel.tagName && /TD|TH/.test(priceLabel.tagName)) {
                            const row = priceLabel.closest('tr');
                            if (row) {
                                const cells = Array.from(row.querySelectorAll('td,th'));
                                const idx = cells.indexOf(priceLabel);
                                if (idx >= 0 && cells[idx + 1]) candidateCell = cells[idx + 1];
                            }
                        }
                        if (!candidateCell && priceLabel.nextElementSibling) candidateCell = priceLabel.nextElementSibling;

                        const p = normNum(candidateCell ? candidateCell.textContent : '');
                        if (p) {
                            price = p;
                            parseMeta.priceSource = 'label:–¶–µ–Ω–∞, BYN (fallback-only)';
                        }
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ DOM –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
            }

            const change = state?.stockData?.change || '9.40';
            const changePercent = state?.stockData?.changePercent || '29.37%';

            console.log('‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω–æ:', { date, price, min, max, avg, parseMeta });

            return {
                date: date || '‚Äî',
                price: price || '‚Äî',
                change,
                changePercent,
                secondary: {
                    min: min || '‚Äî',
                    max: max || '‚Äî',
                    avg: avg || '‚Äî'
                },
                _parseMeta: parseMeta
            };
        }

        // Load data from BCSE with improved proxy list
        async function refreshFromBcse() {
            const refreshBtn = document.getElementById('refreshFromBcse');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
            refreshBtn.disabled = true;
            
            // Update status
            document.getElementById('secondaryStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ë–í–§–ë...';
            
            try {
                // Try multiple proxy services
                const proxyUrls = [
                    `https://r.jina.ai/http://${STOCK_URL}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(STOCK_URL)}`,
                    `https://corsproxy.io/?${encodeURIComponent(STOCK_URL)}`,
                    `https://cors-anywhere.herokuapp.com/${STOCK_URL}`,
                    `https://thingproxy.freeboard.io/fetch/${STOCK_URL}`
                ];
                
                let data = null;
                let lastError = null;
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        console.log(`üîÑ –ü—Ä–æ–±—É—é –ø—Ä–æ–∫—Å–∏: ${proxyUrl}`);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                                'Accept-Language': 'ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3',
                                'Accept-Encoding': 'gzip, deflate',
                                'Connection': 'keep-alive',
                                'Upgrade-Insecure-Requests': '1',
                                'Cache-Control': 'no-cache'
                            },
                            timeout: 30000
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const html = await response.text();
                        console.log('‚úÖ HTML –ø–æ–ª—É—á–µ–Ω, –¥–ª–∏–Ω–∞:', html.length);
                        
                        // Parse the data
                        data = await parseBcseData(html);
                        
                        if (data) {
                            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã');
                            break;
                        }
                    } catch (error) {
                        console.warn(`‚ùå –ü—Ä–æ–∫—Å–∏ ${proxyUrl} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:`, error.message);
                        lastError = error;
                        continue;
                    }
                }
                
                if (data) {
                    // Update state with new data
                    state.stockData = {
                        ...state.stockData,
                        ...data,
                        secondary: {
                            ...(state.stockData.secondary || {}),
                            ...(data.secondary || {})
                        }
                    };
                    saveState();
                    updateUI();

                    const meta = data._parseMeta;
                    const metaText = meta ? ` (—Ü–µ–Ω–∞: ${meta.priceSource}, –∏—Ç–æ–≥–∏: ${meta.secondarySource})` : '';
                    showToast('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –ë–í–§–ë!' + metaText, 'success');
                    document.getElementById('secondaryStatus').innerHTML = '<i class="fas fa-check-circle text-green-500"></i> –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ë–í–§–ë' + (meta ? `<span class="ml-1 opacity-75">${metaText}</span>` : '');
                } else {
                    throw new Error(lastError || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                showToast(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${error.message}`, 'error');
                document.getElementById('secondaryStatus').innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.';
            } finally {
                refreshBtn.innerHTML = originalContent;
                refreshBtn.disabled = false;
            }
        }

        // Auto-send scheduler
        function startScheduler() {
            setInterval(async () => {
                if (!state.autoSendEnabled) return;
                
                const now = new Date();
                const moscowTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Moscow"}));
                
                // Check if it's weekday and 09:00 MSK
                const day = moscowTime.getDay();
                const hour = moscowTime.getHours();
                const minute = moscowTime.getMinutes();
                
                const isWeekday = day >= 1 && day <= 5;
                const isTargetTime = hour === 9 && minute === 0;
                
                const todayKey = moscowTime.toISOString().split('T')[0];
                const alreadySent = state.lastAutoSendKey === todayKey;
                
                if (isWeekday && isTargetTime && !alreadySent) {
                    console.log('üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏...');
                    
                    // First refresh data from BCSE
                    await refreshFromBcse();
                    
                    // Then send notification
                    const message = state.notificationFormat === 'brief' 
                        ? `üìà ${state.stockData.date}: ${state.stockData.price} BYN (${state.stockData.changePercent})`
                        : `üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ü–µ–Ω–Ω–æ–π –±—É–º–∞–≥–µ</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ <b>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏:</b> ${state.stockData.date}
üí∞ <b>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</b> ${state.stockData.price} BYN
üìä <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã:</b> +${state.stockData.change} BYN
üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:</b> +${state.stockData.changePercent}

üßæ <b>–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á.):</b>
‚Ä¢ –º–∏–Ω.: ${state.stockData.secondary.min}
‚Ä¢ –º–∞–∫—Å.: ${state.stockData.secondary.max}
‚Ä¢ —Å—Ä–≤–∑: ${state.stockData.secondary.avg}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîó <a href="${STOCK_URL}">–ò—Å—Ç–æ—á–Ω–∏–∫: –ë–í–§–ë</a>

‚è∞ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
                    
                    const result = await sendTelegramMessage(state.chatId, message);
                    
                    if (result.success) {
                        state.lastAutoSendKey = todayKey;
                        saveState();
                        showToast('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
                    } else {
                        showToast(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.error}`, 'error');
                    }
                }
            }, 20000); // Check every 20 seconds
        }

        // Event Listeners
        document.getElementById('botSettingsForm').addEventListener('change', (e) => {
            state[e.target.id] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
            saveState();
            updateNotificationPreview();
        });

        document.getElementById('testNotification').addEventListener('click', async () => {
            const btn = document.getElementById('testNotification');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            btn.disabled = true;
            
            const message = state.notificationFormat === 'brief' 
                ? `üìà –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${state.stockData.price} BYN (${state.stockData.changePercent})`
                : `üìà <b>–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ <b>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏:</b> ${state.stockData.date}
üí∞ <b>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</b> ${state.stockData.price} BYN
üìä <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã:</b> +${state.stockData.change} BYN
üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:</b> +${state.stockData.changePercent}

üßæ <b>–ò—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–≤—Ç–æ—Ä–∏—á.):</b>
‚Ä¢ –º–∏–Ω.: ${state.stockData.secondary.min}
‚Ä¢ –º–∞–∫—Å.: ${state.stockData.secondary.max}
‚Ä¢ —Å—Ä–≤–∑: ${state.stockData.secondary.avg}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîó <a href="${STOCK_URL}">–ò—Å—Ç–æ—á–Ω–∏–∫: –ë–í–§–ë</a>

‚è∞ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
            
            const result = await sendTelegramMessage(state.chatId, message);
            
            if (result.success) {
                showToast('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
            } else {
                showToast(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.error}`, 'error');
            }
            
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });

        document.getElementById('activateBot').addEventListener('click', async () => {
            const btn = document.getElementById('activateBot');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ê–∫—Ç–∏–≤–∞—Ü–∏—è...';
            btn.disabled = true;
            
            const message = `‚úÖ <b>–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</b>

üìÖ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</b>
‚Ä¢ Chat ID: ${state.chatId}
‚Ä¢ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${state.notificationTime} (–ú–°–ö)
‚Ä¢ –§–æ—Ä–º–∞—Ç: ${state.notificationFormat === 'brief' ? '–ö—Ä–∞—Ç–∫–∏–π' : '–ü–æ–¥—Ä–æ–±–Ω—ã–π'}
‚Ä¢ –ê–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞: ${state.autoSendEnabled ? '–í–∫–ª—é—á–µ–Ω–∞' : '–í—ã–∫–ª—é—á–µ–Ω–∞'}

üîî <b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è:</b>
‚Ä¢ –ö–∞–∂–¥—ã–µ –±—É–¥–Ω–∏–µ –¥–Ω–∏ –≤ ${state.notificationTime} –ø–æ –ú–°–ö
‚Ä¢ –í–∫–ª—é—á–∞—è –∏—Ç–æ–≥–∏ —Ç–æ—Ä–≥–æ–≤ (–º–∏–Ω/–º–∞–∫—Å/—Å—Ä–≤–∑)

‚è∞ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
            
            const result = await sendTelegramMessage(state.chatId, message);
            
            if (result.success) {
                showToast('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
            } else {
                showToast(`‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: ${result.error}`, 'error');
            }
            
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });

        document.getElementById('refreshFromBcse').addEventListener('click', refreshFromBcse);

        // Modal controls
        document.getElementById('editSecondaryBtn').addEventListener('click', () => {
            document.getElementById('editMin').value = state.stockData.secondary.min;
            document.getElementById('editMax').value = state.stockData.secondary.max;
            document.getElementById('editAvg').value = state.stockData.secondary.avg;
            document.getElementById('editModal').classList.remove('hidden');
        });

        document.getElementById('saveSecondary').addEventListener('click', () => {
            state.stockData.secondary.min = document.getElementById('editMin').value;
            state.stockData.secondary.max = document.getElementById('editMax').value;
            state.stockData.secondary.avg = document.getElementById('editAvg').value;
            saveState();
            updateUI();
            document.getElementById('editModal').classList.add('hidden');
            showToast('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
        });

        document.getElementById('cancelEdit').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        // Update time display
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ru-RU');
            document.getElementById('previewTime').textContent = now.toLocaleString('ru-RU');
            
            // Update next send time
            if (state.autoSendEnabled) {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                while (tomorrow.getDay() === 0 || tomorrow.getDay() === 6) {
                    tomorrow.setDate(tomorrow.getDate() + 1);
                }
                document.getElementById('nextSend').textContent = tomorrow.toLocaleDateString('ru-RU');
            }
        }

        // Initialize
        loadState();
        updateTime();
        setInterval(updateTime, 1000);
        startScheduler();
        
        // Auto-load data on page load
        setTimeout(() => {
            refreshFromBcse();
        }, 1000);
    </script>
</body>
</html>